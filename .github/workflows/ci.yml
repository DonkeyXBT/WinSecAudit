name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -ExcludeRule PSAvoidUsingWriteHost
          $results | Format-Table -AutoSize
          if ($results.Count -gt 0) {
            Write-Warning "PSScriptAnalyzer found $($results.Count) issues"
          }

  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Import Module
        shell: pwsh
        run: |
          Import-Module .\WinSecAudit.psm1 -Force -ErrorAction Stop
          Write-Host "Module imported successfully"

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'test-results.xml'
          if (Test-Path './tests') {
            Invoke-Pester -Configuration $config
          } else {
            Write-Host "No tests directory found, skipping tests"
          }

  security:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Secrets
        shell: pwsh
        run: |
          $patterns = @(
            'password\s*=\s*["\x27][^\x27"]+["\x27]',
            'apikey\s*=\s*["\x27][^\x27"]+["\x27]',
            'secret\s*=\s*["\x27][^\x27"]+["\x27]'
          )
          $files = Get-ChildItem -Recurse -Include *.ps1,*.psm1,*.psd1
          $found = $false
          foreach ($file in $files) {
            $content = Get-Content $file.FullName -Raw
            foreach ($pattern in $patterns) {
              if ($content -match $pattern) {
                Write-Warning "Potential secret found in $($file.Name)"
                $found = $true
              }
            }
          }
          if ($found) { exit 1 }
